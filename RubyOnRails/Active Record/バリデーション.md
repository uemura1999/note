## バリデーションの概要
- バリデーションのTrigger
  - モデルの保存時(下記のメソッドが動く前)に自動的に検証される
    - save, update
      - 検証でデータが保存されない場合はfalseを返す
    - create
      - 保存されなくてもオブジェクト自身を返す
    - メソッド名の末尾に！をつける
      - 例外処理(エラー文)を返す
      - 保存理由がわからないときにエラーの原因を探れる！
- バリデーションを定義
  - モデルに記入
  ```
  validates :カラム名, ヘルパー
  ```
## バリデーションヘルパー
- どういう検証を行うかを定義できる主なヘルパーを紹介
  - presence
    - カラムが空でないかを検証する
    ```rb
    class Person < ApplicationRecord
      validates :name, presence: true, message: "must be given please"
    end
    ```
  - absence
    - カラムが空であるかを検証する
    ```rb
      validates :name, absence: true, message: "must be blank please"
    ```
  - uniqueness
    - カラムの値が一意であり重複してないかを検証する
    - すでに値が存在しているものと同じ値であれば保存されない
    ```rb
      validates :name, uniqueness: true, message: "must be unique please"
    ```
  - scope
    - 一意性チェックの範囲を限定する
    - 一人のユーザがタグの名前に同じものを使えないようにする
    ```rb
      belongs_to :user
      validates :name, uniqueness: { scope: :user }
    ```
  - case_sensitive
    - 大文字と小文字を区別するかどうかを指定する
    - 区別する場合はtrue、区別しない場合はfalse
    ```rb
      validates :name, uniqueness: { case_sensitive: false }
    ```
  - acceptance
    - チェックボックスがチェックされているかを検証する
    - チェックされていない場合は保存されない
    ```rb
      validates :terms_of_service, acceptance: true
    ```
  - confirmation
    - ２つのフォームで入力した内容が一致しているかを検証する
    - 確認用カラム名は末尾に_confirmationをつける
    ```rb
      validates :password, confirmation: true
    ```
  - inclusion
    - カラムの値が指定した文字になっているかを検証する
    - %記法とは？
      - %i( )で囲んだ中の文字列をシンボルの配列として返す
      - %w( )で囲んだ中の文字列を文字列の配列として返す
    ```rb
    class Coffee < ApplicationRecord
    # １つのワードを指定
      validates :カラム名, inclusion: { in: ["検証したい文字"] }
    # 複数のワードを指定
      validates :カラム名, inclusion: { in: %w(検証したい文字1 検証したい文字2) }
    # 数字の範囲を指定
      validates :カラム名, inclusion: { in: 1..10 }
    # 範囲を指定
      validates :カラム名, inclusion: { in: %w(大 中 小) }
    ```
  - exclusion
    - 指定された値が含まれていないかを検証する
    ```rb
      validates :カラム名, exclusion: { in: %w(検証したくない文字) }
    ```
  - length
    - 文字列の長さを検証する
    - 文字列の長さを指定
    ```rb
      validates :カラム名, length: { is: 5 } # ５文字かどうか
      validates :カラム名, length: { in: 1..10 }　# １文字以上１０文字以下かどうか
      validates :カラム名, length: { minimum: 5 } # ５文字以上かどうか
      validates :カラム名, length: { maximum: 10 } # １０文字以下かどうか
    ```
  - format
    - 正規表現と属性の値が合致するのかを検証する
    - 下のコードはカラムの値がアルファベットのみであるかを検証する
    - よく使う正規表現を知りたい時はサイトを検索する
    ```rb
      validates :カラム名, format: { with: /\A[a-zA-Z]+\z/, message: "only allows letters" }
    ```
  - numericality
    - カラムの値が数値のみが含まれているかを検証する
    - 他にも制約を指定できる（必要に応じネットで調べる）
    ```rb
      # 整数かどうか
      validates :カラム名, numericality: { only_integer: true }
      # 小数かどうか
      validates :カラム名, numericality: { only_float: true }
      # 0以上100未満かどうか
      validates :カラム名, numericality: { greater_than: 0, less_than: 100 }
    ```
## バリデーションの共通オプション
- バリデータ間で共通して使えるオプションのリスト
  - allow_nil
    - nilの場合は検証をスキップする
    ```rb
      validates :カラム名, presence: true, allow_nil: true
    ```
  - allow_blank
    - 空文字の場合は検証をスキップする
    ```rb
      validates :カラム名, presence: true, allow_blank: true
    ```
  - :message
    - 検証失敗時に表示するエラーメッセージを指定する
    ```rb
      validates :カラム名, presence: { message: "省略できません" }
      # 動的な属性値を含む場合
      validates :カラム名, presence: { message: "%{value}は省略できません" }
    ```
  - :on
    - 検証を実行するタイミングを指定する
    - :onオプションの指定がない場合は、保存時に検証を実行する
    ```rb
      validates :カラム名, presence: true, on: :create
      validates :カラム名, presence: true, on: :update
      validates :カラム名, presence: true, on: :save
    ```
##  便利なメソッド
- バリデーションの結果を確認するメソッド
  - valid?
    - バリデーションを実行して、エラーがなければtrueを返す
    - newメソッドは実行時に検証されないため、保存を確認するために使用する
  - invalid?
    - バリデーションを実行して、エラーがあればtrueを返す
    ```rb
    class Person < ApplicationRecord
      validates :name, presence: true
    end
    ```
    ```rb
    irb> Person.create(name: "John Doe").valid?
    => true
    irb> Person.create(name: nil).valid?
    => false
    ```
- いま起きているエラーを確認するメソッド
  ```rb
  validates :text, presence: true
  ```
  ```rb
  # エラーメッセージを確認
  irb> person.errors
  => @messages={:text=>["can't be blank"]}>
  # カラムを指定してエラーメッセージを確認
  irb> person.errors[:text]
  => ["can't be blank"]
  # カラムごとのエラーメッセージを確認
  irb> person.errors.messages
  => {:text=>["can't be blank"]}
  # 詳細なエラーメッセージを確認
  irb> person.errors.full_messages
  => ["Text can't be blank"]
  # エラーメッセージがあるかどうかを確認
  irb> person.errors.any?
  => true
  # オブジェクトのエラー総数を確認
  irb> person.errors.size
  => 1
  ```
##  バリデーションに条件をつけよう
- バリデーションを実行するかどうかを条件分岐できる
  - ifオプション
    - ブロック内の条件がtrueの場合にバリデーションを実行する
  - unlessオプション
    - ブロック内の条件がfalseの場合にバリデーションを実行する
    ```rb
    class Person < ApplicationRecord
      validates :name, presence: true, if: :is_admin?
      def is_admin?
        true
      end
    end
    ```
  - with_optionsオプション
    - １つの条件を複数のバリデーションに適用する
      - 両方のカラムに値が存在しなければならない
      - 全角カタカナで入力をしないといけない
    ```rb
    class Person < ApplicationRecord
      with_options presence: true, format: { with:/\A[ァ-ヶー－]+\z/, message: '全角カタカナで入力してください' } do
        validates :first_name_kana
        validates :last_name_kana
      end
    end
    ```
  - Procオブジェクト
    - ブロックをオブジェクト化したもの
    - ブロック内の条件がtrueの場合にバリデーションを実行する
    ```rb
    class Person < ApplicationRecord
      validates :name, presence: true, if: Proc.new { |person| person.is_admin? }
      def is_admin?
        true
      end
    end
    ```

- 参考資料
  - https://pikawaka.com/rails/validation
## バリデーションの概要
- バリデーションとは？
  - 入力されたデータが特定の条件を満たしているかどうかを確認すること
- バリデーションを行う理由
  - 正しいデータだけをDBに保存するため
  - 不正なデータがシステムに入力されるリスクを防ぐため
- バリデーションのTrigger
  - モデルの保存時(下記のメソッドが動く前)に自動的に検証される
    - save, update
      - 検証でデータが保存されない場合はfalseを返す
    - create
      - 保存されなくてもオブジェクト自身を返す
    - メソッド名の末尾に！をつける
      - レコードが無効な場合に、例外が発生する
- バリデーションを定義
  - モデルに記入
    -  validates :カラム名, ヘルパー
- バリデーションのスキップ
  - バリデーションを行わずにスキップできる
    - 1.3 バリデーションのスキップに記載
    - オブジェクトの保存は、有効無効に関わらず行われる
  - saveのバリデーションをスキップするには？
    - save(validate: false)
- バリデーションを手動で実行するには
  - valid?メソッド
    - エラーがないとtrueを返し、エラーがあるとfalseを返す
  - invalid?メソッド
    - エラーがないとfalseを返し、エラーがあるとtrueを返す

## バリデーションヘルパー
- どういう検証を行うかを定義できる主なヘルパーを紹介
  - validates :カラム名, ヘルパー
- 主なヘルパー
  - acceptance
    - チェックボックスがチェックされているかを検証する
      - チェックされていない場合は保存されない
  - confirmation
    - ２つのフォームで入力した内容が一致しているかを検証する
      - 確認用カラム名は末尾に_confirmationをつける
  - comparison
    - カラムの値が指定した値と比較しているかを検証する
  - format
    - 正規表現と属性の値が合致するのかを検証する
      - 正規表現：登録されるデータのフォーマットを調整する処理
        - パスワードが10文字未満, @の有無, アルファベットのみなど
  - inclusion
    - カラムの値が指定した文字になっているかを検証する
  - exclusion
    - 指定された値が含まれていないかを検証する
  - length
    - 文字列の長さを検証する
  - numericality
    - 数値のみが含まれているかを検証する
    - presence
      - カラムが空でないかを検証する
  - absence
    - カラムが空であるかを検証する
  - uniqueness
    - カラムの値が一意であり重複してないかを検証する
      - すでに値が存在しているものと同じ値であれば保存されない
  - validates_associated
    - 関連するオブジェクトが有効かどうかを検証する
      - オブジェクトを保存しようとするたびに関連するオブジェクトごとにvalid?を呼び出す

## バリデーションの共通オプション
- バリデータ間で共通して使えるオプションのリスト
  - allow_nil
    - nilの場合は検証をスキップする
  - allow_blank
    - 空文字の場合は検証をスキップする
  - :message
    - 検証失敗時に表示するエラーメッセージを指定する
  - :on
    - 検証を実行するタイミングを指定する
    - :onオプションの指定がない場合は、保存時に検証を実行する

##  厳密なバリデーション
- strictオプション
  - バリデーションを厳密にし、オブジェクトが無効だった場合に例外を発生させる

##  条件付きバリデーション
- 特定の条件を満たす場合にのみバリデーションを実行する
  - ifオプション
    - ブロック内の条件がtrueの場合にバリデーションを実行する
  - unlessオプション
    - ブロック内の条件がfalseの場合にバリデーションを実行する
  - Procオブジェクト
    - ブロックをオブジェクト化したもの
    - ブロック内の条件がtrueの場合にバリデーションを実行する
  - with_optionsオプション
    - １つの条件を複数のバリデーションに適用する
  - Arrayオブジェクト
    - バリデーションを行う条件を複数定義する
    - すべての条件がtrueの場合にバリデーションを実行する

##  カスタムバリデーションを実行する
- カスタムバリデータ
  - 自分でバリデータやバリデーションメソッドを作成できる
    - app/配下にvalidatorsディレクトリを作成することで自動で読み込む
  - validateメソッド
    - ActiveModel::Validatorを継承するクラス
    - 引数としてrecordを受け取る
  - validate_eachメソッド
    - １つの属性に対してのカスタムバリデータを定義できる
    - ActiveModel::EachValidatorを継承するクラス
    - クラス名は、<検証名>Validatorの形式で命名
    - 引数として、record, attribute, valueを受け取る
      - record
        - バリデーション対象のモデルのインスタンス
      - attribute
        - バリデーション対象の属性名
      - value
        - バリデーション対象の属性の値
- カスタムメソッド
  - バリデーションを実行するメソッド
  - バリデーションが失敗した場合は、エラーメッセージを追加し成功した場合は何もしない
  - valid?の呼び出しやオブジェクトを保存するたびに実行される
    - :onオプションを使えばタイミングを指定できる
- バリデータを一覧表示する
  - validatorsメソッド
    - モデルに定義されているバリデータを一覧表示する
      - モデル名.validators

##  バリデーションエラーに対応する
- errorsコレクションのメソッドを使えば、個別のエラーを更に詳しく調べられる
  - valid?メソッドやinvalid?メソッドは有効かどうかの概要しかわからない
- 最もよく使われるメソッドの一覧
  - errors
    - オブジェクトのエラーコレクションを返す
  - errors[]
    - 特定の属性についてエラーメッセージをチェック(true/false)したい場合に使う
  - errors.whereとエラーオブジェクト
    - 特定の属性に関連するエラーメッセージを取得できる
  - errors.add
    - 特定の属性に関するエラーメッセージを手動で追加する
  - errors[:base]
    - オブジェクトのステート全体に関連するエラーメッセージを追加する
  - errors.size
    - オブジェクトのエラー総数を返す
  - errors.clear
    - errorsコレクションに含まれるメッセージを全て削除する

- 参考資料
  - 【Rails】 Railsのバリデーションの使い方をマスターしよう！
    - https://pikawaka.com/rails/
  - Rails カスタムバリデーション(validator, EachValidator)
    - https://qiita.com/its532/items/5783b5953b4202e74b83

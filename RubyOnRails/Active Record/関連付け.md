##  アソシエーションの事前知識
- リレーションシップ
  - データベースのテーブル同士の関係性
    - サイトでどの商品に対するレビューなのか識別するために、商品テーブルとレビューテーブルを紐付ける
- 主キーと外部キー制約のカラム
  - 主キー
    - テーブルの情報を一意に識別するためのもの
  - 外部キー
    - 他のテーブルのデータを参照するため制約を付けたカラム
    - カラム名は`参照するテーブル名(単数形)_id`
### アソシエーションを使用する場合としない場合を比較
- アソシエーションを使用しない場合
```rb
# findメソッドを使用して、idが1の商品を取得
@product = Product.find(1)
# whereメソッドを使用して、product_idが1のレビューを取得
@reviews = Review.where(product_id: @product.id)
```
- アソシエーションを使用する場合
```rb
@product = Product.find(1)
# その商品に属しているレビューを全て取得
@reviews = @product.reviews
```
##  アソシエーションの種類
- belongs_toメソッド
  - 参照元テーブル(外部キー)から参照先テーブル(主キー)にアクセス
    - レビューは必ずどれか１つの商品に属している(N:1)
  - メソッドを定義する
    - モデル名は関連名(単数形)に属する（belongs_to）
  ```rb
  class Review(モデル名) < ActiveRecord::Base
    belongs_to :product(関連名)
  end
  ```
- has_manyメソッド
  - 参照元テーブル(主キー)から参照先テーブル(外部キー)にアクセス
    - 1つの商品は0以上のレビューを持っている(1:N)
  - メソッドを定義する
    - １つのモデルは複数の関連名を持つ（has_many）
  ```rb
  class Product(モデル名) < ActiveRecord::Base
    has_many :reviews(関連名)
  end
  ```
- Productモデル経由でReviewモデルにアクセスする
  ```rb
  # Controller
  def hasmany
    # 商品id=1(冷蔵庫)のレビューを全て取得する
    @product = Product.find(1)
  end
  # 複数のレビューのレコードが配列で返ってくる
  @product.reviews
  ```
  - アソシエーションを使って関連するレビューを取得する
    ```html
    # View
    <h2>商品名: <%= @product.name %></h2>
    <ul>
    <% @product.reviews.each do |review| %>
      <li><%= review.body %></li>
    <% end %>
    </ul>
    ```
- 多対多をテーブル間のリレーションで表現するには？
  - 多対多の関係とは？
    - 1人のユーザーは複数の部署に所属でき、1つの部署は複数のヒトが入れる
  - 中間テーブルとは？
    - 複数テーブルの外部キー制約のカラムを持つテーブル
  - なぜ、中間テーブルが必要？
    - カラム数が多くなるため
      - 開発部署の人数が増えるたびにカラムを人数分追加する
    - NULLが入ってしまうアンチパターンという設計になる
      - 部署に所属していない人のカラムにはNULLが入る
  - 多対多の関連を定義する
    - 中間テーブルを経由(through)して関連先のオブジェクトを取
    ```rb
    class モデル名 < ActiveRecord::Base
      has_many :関連名, through: :中間テーブル名
      has_many :中間テーブル名
    end
    ```
    - メンバーと部署の多対多を定義する
      - 1つのUserオブジェクトはAuthorizationモデルを経由して複数のDepartmentオブジェクトを持っている
    ```rb
    # has_many throughオプションを定義
    class User < ActiveRecord::Base
      has_many :departments, through: :authorizations
      has_many :authorizations
    end
    ```
    ```rb
    # has_many throughオプションを定義
    class Department < ActiveRecord::Base
      has_many :users, through: :authorizations
      has_many :authorizations
    end
    ```
    ```rb
    # belongs_toメソッドを定義
    class Authorization < ActiveRecord::Base
      belongs_to :user
      belongs_to :department
    end
    ```
- has_oneメソッド
  - 参照元テーブル(主キー)に外部キー制約の付いたカラムをもたせる
    - 1つのメンバーは1つのアカウントを持っている(1:1)
  - メソッドを定義する
    - １つのモデルは１つの関連名を持つ（has_one）
  ```rb
  class User(モデル名) < ActiveRecord::Base
    has_one :account(関連名)
  end
  ```
##  アソシエーションで利用可能なオプション
- foreign_keyオプション
  - 外部キー制約のカラム名を変更する
    - デフォルトでは、参照先モデル名(単数形)_id
  ```rb
  class Review < ActiveRecord::Base
    belongs_to :product, foreign_key: "product_id"
  end
  ```